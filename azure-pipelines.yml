trigger:
- master

variables:
  MONO_REVISION: '2020-02'

jobs:
- job: Build_Mono
  timeoutInMinutes: 0
  pool:
   vmImage: 'windows-2019'
  steps:
  - powershell: |
      choco install mono 2>&1>$null
      choco install cygwin --params "/InstallDir:C:\cygwin /NoStartMenu" 
      choco install cyg-get
    displayName: 'Fetch Cygwin'
  - script: |
      mkdir Binaries
      git clone --recurse-submodules https://github.com/mono/mono.git
    displayName: 'Fetch mono repo'
  - task: BatchScript@1
    inputs:
      filename: 'C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\Tools\VsDevCmd.bat'
      modifyEnvironment: True
  - bash: |
      export PREFIX=$(pwd)/Binaries
      export PATH='C:/Program Files/Mono/bin':$PATH
      cd mono
      ./autogen.sh --prefix=$PREFIX --host=i686-w64-mingw32--enable-msvc --disable-boehm
      make get-monolite-latest
      make -j4
      make install
      ./autogen.sh --prefix=$PREFIX --host=x86_64-w64-mingw32 --enable-msvc --disable-boehm
      make -j4
      make install    
    displayName: 'Build mono'
    continueOnError: true
    failOnStderr: false
  - powershell: |
      7z a mono.zip Binaries\*
    displayName: 'Copy Binaries'
  - publish: $(Build.SourcesDirectory)/mono.zip
    artifact: Mono Binaries
  
  - task: GitHubRelease@1
    inputs:
      gitHubConnection: 'msmshazan Github PAT'
      repositoryName: 'msmshazan/monobuild'
      action: 'create'
      target: '$(Build.SourceVersion)'
      tagSource: 'userSpecifiedTag'
      tag: 'Release-$(MONO_REVISION)'
      title: 'Mono Binaries'
      changeLogCompareToRelease: 'lastFullRelease'
      changeLogType: 'commitBased'
      assets: '$(Build.SourcesDirectory)/mono.zip'
